<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/deepmerge@4.2.2/dist/umd.js"></script>
<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src="/js/weekly-reports/LineChart.js"></script>
<script>

  var chart1 = {{ .Params.chart1data }}
  var chart2 = {{ .Params.chart2data }}

  function slugify(string) {
    var a = 'àáâäæãåāăąçćčđďèéêëēėęěğǵḧîïíīįìłḿñńǹňôöòóœøōõőṕŕřßśšşșťțûüùúūǘůűųẃẍÿýžźż·/_,:;'
    var b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'
    var p = new RegExp(a.split('').join('|'), 'g')

    return string.toString().toLowerCase()
      .replace(/\s+/g, '-') // Replace spaces with -
      .replace(p, function (c) { return b.charAt(a.indexOf(c)) }) // Replace special characters
      .replace(/&/g, '-and-') // Replace & with 'and'
      .replace(/[^\w\-]+/g, '') // Remove all non-word characters
      .replace(/\-\-+/g, '-') // Replace multiple - with single -
      .replace(/^-+/, '') // Trim - from start of text
      .replace(/-+$/, '') // Trim - from end of text
  }

  function getCurrentURL() {
    return window.location.protocol + '//' + window.location.host + window.location.pathname
  }

  /**
   * Function to parse month strings and make them for
   * the current year 
   */
  var monthParser = function(d) {
    d = d + ' 2020' // TODO: don't hardcode 2020
    var parser = d3.timeParse("%B %Y")
    return parser(d)
  }

  /**
   * Pads the X extent to cover all months
   */
  var xPadExtent = function(extent) {
    return [ 
      d3.timeMonth.floor(extent[0]), 
      d3.timeMonth.ceil(extent[1]) 
    ]
  }

  /**
   * Pads the extent by a % value provided
   * @param {[number, number]} extent
   * @param {number} padding (percent to pad)
   * @returns {[number, number]} [min, max]
   */
  var yPadExtent = function (extent) {
    var padding = 0.05
    var range = extent[1] - extent[0]
    var pad = padding * range
    return [extent[0], extent[1] + pad]
  }

  function createConfig(config) {
    var BASE_CONFIG = {
      parse: {
        x: monthParser,
        y: parseFloat,
        area: d3.timeParse("%d/%m/%Y")
      },
      format: {
        x: d3.timeFormat("%b"),
        y: d3.format(",d"),
        xTooltip: d3.timeFormat("%B"),
        yTooltip: d3.format(",d"),
        area: d3.timeFormat("%d/%m/%Y"),
        label: function(id) { return id }
      },
      view: {
        type: "bar",
        xTicks: d3.timeMonth.every(1),
        yTicks: 5
      },
      extent: {
        xPad: xPadExtent,
        yPad: yPadExtent
      }
    }
    return deepmerge(BASE_CONFIG, config)
  }

  var LINE_CHART_CONFIG = createConfig({
    url: chart2,
    groupType: 'row',
    data: {
      area: ['start_of_moratorium', 'end_of_moratorium'],
      x: 'month',
      y: {
        'groupBy': 'group',
        col: 'month_diff'
      },
      extra: ['month_last_day'],
    },
    format: {
      y: d3.format(",.0%"),
      yTooltip: d3.format(",.0%"),
    },
    view: {
      type: "line",
    }
  });


  $(document).ready(function () {

    $('.table').tablesorter()

    $('.table__row').click(function () {
      var placeName = $(this).data("name")
      if (placeName) {
        var slug = slugify(placeName)
        window.location.href = getCurrentURL() + slug
      }
    })


    var CHART_1_CONFIG = createConfig({
      url: chart1,
      groupType: 'col',
      id: 'filings',
      title: 'Monthly Eviction Filings',
      data: {
        x: 'month',
        y: {
          cols: [
            'avg_filings',
            'month_filings'
          ]
        },
        extra: ['month_last_day'],
      }
    });

    var CHART_1A_CONFIG = createConfig({
      url: chart1,
      groupType: 'col',
      id: 'avg',
      title: 'Monthly Eviction Filings Relative To Average',
      data: {
        x: 'month',
        y: {
          cols: [
            'percentage_diff'
          ]
        },
        extra: ['month_last_day'],
      },
      format: {
        y: d3.format(",.0%"),
        yTooltip: d3.format(",.0%"),
      }
    })

    var button1 = $('#toggleChartOne')
    var currentConfig = CHART_1_CONFIG

    createChart("#filingsChart", CHART_1_CONFIG, function(chart) {
      button1.on("click", function() {
        if (currentConfig.id === 'avg') {
          currentConfig = CHART_1_CONFIG
        } else {
          currentConfig = CHART_1A_CONFIG
        }
        chart.update(currentConfig)
      })
    })

    var CHART_2_CONFIG = createConfig({
      url: chart2,
      groupType: 'row',
      id: 'diff',
      title: '',
      data: {
        x: 'month',
        y: {
          'groupBy': 'group',
          col: 'month_diff'
        },
        extra: ['month_last_day'],
      },
      format: {
        y: d3.format(",.0%"),
        yTooltip: d3.format(",.0%"),
      }
    });

    var CHART_2A_CONFIG = createConfig({
      url: chart2,
      groupType: 'row',
      id: 'filings',
      data: {
        x: 'month',
        y: {
          'groupBy': 'group',
          col: 'month_filings'
        },
        extra: ['month_last_day'],
      }
    })

    var button2 = $('#toggleChartTwo')
    var config2 = CHART_2_CONFIG

    createChart("#raceChart", config2, function(chart) {
      console.log(chart)
      button2.on("click", function() {
        if (config2.id === 'diff') {
          config2 = CHART_2A_CONFIG
        } else {
          config2 = CHART_2_CONFIG
        }
        chart.update(config2)
      })
      // setTimeout(function() { chart.update(LINE_CHART_CONFIG) }, 4000)
    })
    
  })
</script>