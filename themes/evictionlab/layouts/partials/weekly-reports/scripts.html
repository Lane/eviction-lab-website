<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js"></script>
<script type="text/javascript" src="https://unpkg.com/deepmerge@4.2.2/dist/umd.js"></script>
<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src="/js/weekly-reports/LineChart.js"></script>
<script>

  var chart1 = {{ .Params.chart1data }}
  var chart2 = {{ .Params.chart2data }}

  function slugify(string) {
    var a = 'àáâäæãåāăąçćčđďèéêëēėęěğǵḧîïíīįìłḿñńǹňôöòóœøōõőṕŕřßśšşșťțûüùúūǘůűųẃẍÿýžźż·/_,:;'
    var b = 'aaaaaaaaaacccddeeeeeeeegghiiiiiilmnnnnoooooooooprrsssssttuuuuuuuuuwxyyzzz------'
    var p = new RegExp(a.split('').join('|'), 'g')

    return string.toString().toLowerCase()
      .replace(/\s+/g, '-') // Replace spaces with -
      .replace(p, function (c) { return b.charAt(a.indexOf(c)) }) // Replace special characters
      .replace(/&/g, '-and-') // Replace & with 'and'
      .replace(/[^\w\-]+/g, '') // Remove all non-word characters
      .replace(/\-\-+/g, '-') // Replace multiple - with single -
      .replace(/^-+/, '') // Trim - from start of text
      .replace(/-+$/, '') // Trim - from end of text
  }

  function getCurrentURL() {
    return window.location.protocol + '//' + window.location.host + window.location.pathname
  }

  /**
   * Function to parse month strings and make them for
   * the current year 
   */
  var monthParser = function(d) {
    d = d + ' 2020' // TODO: don't hardcode 2020
    var parser = d3.timeParse("%B %Y")
    return parser(d)
  }

  /**
   * Pads the X extent to cover all months
   */
  var xPadExtent = function(extent) {
    return [ 
      d3.timeMonth.floor(extent[0]), 
      d3.timeMonth.ceil(extent[1]) 
    ]
  }

  /**
   * Pads the extent by a % value provided
   * @param {[number, number]} extent
   * @param {number} padding (percent to pad)
   * @returns {[number, number]} [min, max]
   */
  var yPadExtent = function (extent) {
    var padding = 0.05
    var range = extent[1] - extent[0]
    var pad = padding * range
    return [extent[0], extent[1] + pad]
  }

  var formatLabel = function (id) {
    switch(id) {
      case 'avg_filings':
        return "Average Filings"
      case 'month_filings':
        return "Filings This Year"
      case 'percentage_diff':
        return "Filings This Year <br /><span>relative to average</span>"
      default:
        return id
    }
  }

  function createConfig(config) {
    var BASE_CONFIG = {
      parse: {
        x: monthParser,
        y: parseFloat,
        area: d3.timeParse("%d/%m/%Y")
      },
      format: {
        x: d3.timeFormat("%b"),
        y: d3.format(",d"),
        xTooltip: d3.timeFormat("%B"),
        yTooltip: d3.format(",d"),
        area: d3.timeFormat("%d/%m/%Y"),
        label: formatLabel
      },
      view: {
        type: "bar",
        xTicks: d3.timeMonth.every(1),
        yTicks: 5
      },
      extent: {
        xPad: xPadExtent,
        yPad: yPadExtent
      }
    }
    return deepmerge(BASE_CONFIG, config)
  }

  $(document).ready(function () {

    $('.table').tablesorter()

    $('.table__row').click(function () {
      var placeName = $(this).data("name")
      if (placeName) {
        var slug = slugify(placeName)
        window.location.href = getCurrentURL() + slug
      }
    })


    var CHART_1_CONFIG = createConfig({
      url: chart1,
      groupType: 'col',
      id: 'filings',
      legend: '.section--compare-avg .legend',
      content: [
        {
          selector: '.section--compare-avg .visual__title',
          text: 'Monthly Eviction Filings'
        },
        {
          selector: '.section--compare-avg .visual__toggle',
          text: 'Show relative to average'
        },
        {
          selector: '.section--compare-avg .footnote',
          text: [
            'Average filings taken from 2012 - 2016',
            'Filings for this year provided by January Advisors',
            'Partial filings for April, as of April 18'
          ].map((l,i) => `<span><sup>${i+1}</sup> ${l}</span>`).join('')
        }
      ],
      markLines: [],
      data: {
        x: 'month',
        y: {
          cols: [
            'avg_filings',
            'month_filings'
          ]
        },
        extra: ['month_last_day'],
      },
    });

    var CHART_1A_CONFIG = createConfig({
      url: chart1,
      groupType: 'col',
      id: 'avg',
      legend: '.section--compare-avg .legend',
      content: [
        {
          selector: '.section--compare-avg .visual__title',
          text: 'Monthly Eviction Filings Relative To Average'
        },
        {
          selector: '.section--compare-avg .visual__toggle',
          text: 'Show filing count'
        },
        {
          selector: '.section--compare-avg .footnote',
          text: [
            'Average filings taken from 2012 - 2016',
            'Filings for this year provided by January Advisors',
            'Partial filings for April, as of April 18'
          ].map((l,i) => `<span><sup>${i+1}</sup> ${l}</span>`).join('')
        }
      ],
      markLines: [
        { y: 1, label: 'average filings' }
      ],
      data: {
        x: 'month',
        y: {
          cols: [
            'percentage_diff'
          ]
        },
        extra: ['month_last_day'],
      },
      format: {
        y: d3.format(",.0%"),
        xTooltip: d3.timeFormat("%B %Y"),
        yTooltip: d3.format(",.0%"),
        tooltip: function (d) {
          var distance = d._raw.y - 1
          var value = Math.abs(distance)
				  var dir = distance === 0 ? 'mid' : (distance > 0 ? 'up' : 'down')
          if (dir === 'mid') { return 'Filings about average.'}
          return '<div class="tooltip__item tooltip__item--single tooltip__item--'+ dir +'">' + 
              'Filings&nbsp;<span>' + dir + ' ' + d3.format(",.0%")(value) + '</span>&nbsp;from average' +
              (d._raw.extras['month_last_day'] ? ', <br />as of '+ d._raw.extras['month_last_day'] : '') +
            '.</div>'
        }
      }
    })
    
    var CHART_2_CONFIG = createConfig({
      url: chart2,
      groupType: 'row',
      id: 'diff',
      legend: '.section--race .legend',
      content: [
        {
          selector: '.section--race .visual__title',
          text: 'Filings relative to average, by tract racial majority'
        },
        {
          selector: '.section--race .visual__toggle',
          text: 'Show filing count'
        },
        {
          selector: '.section--race .footnote',
          text: [
            'Average filings taken from 2012 - 2016',
            'Partial filings shown for April, as of April 18'
          ].map((l,i) => `<span><sup>${i+1}</sup> ${l}</span>`).join('')
        }
      ],
      markLines: [
        { y: 1, label: 'average filings' }
      ],
      data: {
        x: 'month',
        y: {
          'groupBy': 'group',
          col: 'month_diff'
        },
        extra: ['month_last_day'],
      },
      format: {
        y: d3.format(",.0%"),
        xTooltip: d3.timeFormat("%B %Y"),
        yTooltip: d3.format(",.0%"),
        tooltip: function (d) {
          var distance = 1-d._raw.y
          var value = Math.abs(distance)
          var dir = distance === 0 ? 'mid' : (distance > 0 ? 'up' : 'down')
          var str = (dir === 'mid')
            ? 'average'
            : d3.format(",.0%")(Math.abs(distance))
          
          return '<div class="tooltip__item tooltip__item--multi">' + 
            '<span>' + d.name + ':</span> ' + 
            '<span>' + d.value + '</span>' + 
            '(<span class="arrow '+dir+'">' + str + '</span>)' +
            '</div>'
        }
      }
    });

    var CHART_2A_CONFIG = createConfig({
      url: chart2,
      groupType: 'row',
      id: 'filings',
      legend: '.section--race .legend',
      content: [
        {
          selector: '.section--race .visual__title',
          text: 'Eviction filings by demographic'
        },
        {
          selector: '.section--race .visual__toggle',
          text: 'Show relative to average'
        },
        {
          selector: '.section--race .footnote',
          text: [
            'Dots represent the average filings for each demographic.',
            'Average filings taken from 2012 - 2016',
            'Partial filings shown for April, as of April 18'
          ].map((l,i) => `<span><sup>${i+1}</sup> ${l}</span>`).join('')
        }
      ],
      markLines: [],
      dots: 'avg_filings',
      data: {
        x: 'month',
        y: {
          'groupBy': 'group',
          col: 'month_filings'
        },
        extra: ['month_last_day', 'avg_filings'],
      },
      format: {
        tooltip: function (d) {
          var distance = d._raw.extras['avg_filings'] - d._raw.y
          var value = Math.abs(distance)
          var dir = distance === 0 ? 'mid' : (distance > 0 ? 'up' : 'down')
          var str = (dir === 'mid')
            ? 'average'
            : d3.format(",d")(Math.abs(distance))
          
          return '<div class="tooltip__item tooltip__item--multi">' + 
            '<span>' + d.name + ':</span> ' + 
            '<span>' + d.value + '</span>' + 
            '(<span class="arrow '+dir+'">' + str + '</span>)' +
            '</div>'
        }
      },
      parse: {
        'avg_filings': parseFloat
      }
    })


    var button1 = $('#toggleChartOne')
    var currentConfig = CHART_1_CONFIG

    createChart("#filingsChart", CHART_1_CONFIG, function(chart) {
      button1.on("click", function() {
        if (currentConfig.id === 'avg') {
          currentConfig = CHART_1_CONFIG
        } else {
          currentConfig = CHART_1A_CONFIG
        }
        chart.update(currentConfig)
      })
    })

    var button2 = $('#toggleChartTwo')
    var config2 = CHART_2_CONFIG

    createChart("#raceChart", config2, function(chart) {
      button2.on("click", function() {
        if (config2.id === 'diff') {
          config2 = CHART_2A_CONFIG
        } else {
          config2 = CHART_2_CONFIG
        }
        chart.update(config2)
      })
    })
    
  })
</script>