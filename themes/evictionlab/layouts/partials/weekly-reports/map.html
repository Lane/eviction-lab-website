<div id="map" class="map"></div>
<script src='https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css' rel='stylesheet' />
<script>

function addDataToGeojson(geojson, data) {
	const dataDict = data.reduce(function (dict, item) {
		dict[item.id] = parseFloat(item["month_diff"])
		return dict;
	}, {})
	const newFeatures = geojson.features.map(function(feature, i) {
		feature.id = parseInt(feature.properties["GEOID"])
		if (dataDict[feature.properties["GEOID"]])
			feature.properties["diff"] = dataDict[feature.properties["GEOID"]]
		return feature
	});
	return Object.assign(geojson, { features: newFeatures })
}

function addChoroplethLayer(map, data, prop, range) {
	map.addSource('choropleth', {
		'type': 'geojson',
		'data': data
	});
	map.addLayer({
		'id': 'choropleth',
		'type': 'fill',
		'source': 'choropleth',
		'layout': {},
		'paint': {
			'fill-color': [
				'interpolate',
				['linear'],
				['get', prop],
				range[0],
				'#2C897F',
				(range[1] - range[0]) / 2,
				'rgba(215, 227, 244, 0.7)',
				range[1],
				'#e24000'
			],
			'fill-opacity':[
				'case',
				['boolean', ['feature-state', 'hover'], false],
				1,
				0.7
			]
		}
	}, "building");
	map.addLayer({
		'id': 'choropleth-stroke',
		'type': 'line',
		'source': 'choropleth',
		'layout': {},
		'paint': {
			"line-color": "rgba(0, 0, 0, 1)",
			"line-width": {
				"stops": [
					[
						10,
						2
					],
					[
						12,
						4
					]
				]
			},
			"line-blur": 0,
			"line-opacity": [
				'case',
				['boolean', ['feature-state', 'hover'], false],
				0.5,
				0
			]
		}
	}, "building");
}

window.onload = function () {
	var geojson = {{ .Site.Data.maps.harris }}
	var csvUrl = {{ .Params.mapdata }}
	var bbox = geojson.bbox
	var padding = 0.15
	var bounds = [[bbox[0] - padding, bbox[1] - padding], [bbox[2] + padding, bbox[3] + padding]]
	var hoveredStateId = null;
	mapboxgl.accessToken = 'pk.eyJ1IjoiZXZpY3Rpb24tbGFiIiwiYSI6ImNqYzJoMzhkbjBncGkyeW4yNGlkbjRkcTQifQ.IQNWME_jYqxTH7wmFrFX-g';
	var map = new mapboxgl.Map({
		container: 'map',
		style: 'mapbox://styles/eviction-lab/ck8za8qns07451jpm48xn6tq2',
		bounds: bounds,
		maxBounds: bounds,
	});

	// disable map zoom when using scroll
	map.scrollZoom.disable();
	// disable map rotation using right click + drag
	map.dragRotate.disable();

	// disable map rotation using touch rotation gesture
	map.touchZoomRotate.disableRotation();
	map.scrollZoom.setWheelZoomRate(0.02); // Default 1/450

	map.on("wheel", event => {

		if (event.originalEvent.ctrlKey || event.originalEvent.metaKey) { // Check if CTRL key is pressed
			event.originalEvent.preventDefault(); // Prevent chrome/firefox default behavior
			if (!map.scrollZoom._enabled) map.scrollZoom.enable(); // Enable zoom only if it's disabled
		} else {
			if (map.scrollZoom._enabled) map.scrollZoom.disable(); // Disable zoom only if it's enabled
		}

	});

	map.addControl(new mapboxgl.NavigationControl());

	// Create a popup, but don't add it to the map yet.
	var popup = document.getElementById('tooltip')
	
	var formatPercent = d3.format(",.0%")

  var getDescription = function(dir, value) {
		if (dir === 'mid') { return 'Filings about average.'}
		return 'Filings <span>' + dir + ' ' + value + '</span> from average.'
	}

	map.on('load', function () {

		d3.csv(csvUrl, function(data) {
			
			var mapData = addDataToGeojson(geojson, data)
			addChoroplethLayer(map, mapData, "diff", [0, 2])

			map.on('mousemove', 'choropleth', function(e) {
				// Change the cursor style as a UI indicator.
				map.getCanvas().style.cursor = 'pointer';
				var placeName = e.features[0].properties.NAME ? e.features[0].properties.NAME.split(',')[0] : 'Unknown'
				var distance = e.features[0].properties.diff - 1
				var dir = distance === 0 ? 'mid' : (distance > 0 ? 'up' : 'down')
				var value = e.features[0].properties.diff ? formatPercent(Math.abs(distance)) : 'Not Available'
				var description = '<h1>' + placeName + '</h1>' +
					'<div class="map__tooltip-row map__tooltip-row--' + dir + '">' + getDescription(dir, value) + '</div>';
				
				var flipped = (e.originalEvent.pageX > (window.innerWidth - 240))
				var space = flipped ? -32 : 32;
				
				tooltip.className = 'chart__tooltip' + (flipped ? ' chart__tooltip--flip' : '')
				tooltip.style.display = 'block'
				tooltip.style.left = e.originalEvent.pageX + space + 'px'
				tooltip.style.top = e.originalEvent.pageY + 32 + 'px'
				tooltip.innerHTML = description

				if (e.features.length > 0) {
					if (hoveredStateId) {
						map.setFeatureState(
							{ source: 'choropleth', id: hoveredStateId },
							{ hover: false }
						);
					}
					hoveredStateId = e.features[0].id;
					map.setFeatureState(
						{ source: 'choropleth', id: hoveredStateId },
						{ hover: true }
					);
				}
			});
			
			map.on('mouseleave', 'choropleth', function() {
				map.getCanvas().style.cursor = '';
				tooltip.style.display = 'none'
				if (hoveredStateId) {
					map.setFeatureState(
						{ source: 'choropleth', id: hoveredStateId },
						{ hover: false }
					);
				}
				hoveredStateId = null;
			});


		})
	})
}
</script>